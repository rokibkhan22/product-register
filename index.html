<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Professional product documentation and image register for Quality/R&D teams">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Product Register">
    <link rel="apple-touch-icon" href="product-register.png">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="product-register.png">
    <title>Product Documentation & Image Register</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --text: #2c3e50;
            --text-light: #7f8c8d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 32px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        /* Form Section */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--light);
        }

        .form-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .form-group label .required {
            color: var(--danger);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            border: 2px dashed var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-direction: column;
            text-align: center;
        }

        .file-input-label:hover {
            border-color: var(--accent);
            background: rgba(52, 152, 219, 0.05);
        }

        .file-input-label.has-file {
            border-color: var(--success);
            background: rgba(39, 174, 96, 0.05);
        }

        #productImage {
            display: none;
        }

        .image-preview-container {
            margin-top: 10px;
            display: none;
        }

        .image-preview-container.active {
            display: block;
        }

        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 160px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .image-info {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 25px;
        }

        .button-group.full {
            grid-template-columns: 1fr;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #d5dbdb;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Table Section */
        .table-section {
            display: flex;
            flex-direction: column;
        }

        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--light);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: var(--primary);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--light);
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .thumbnail {
            width: 60px;
            height: 48px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: transform 0.2s ease;
        }

        .thumbnail:hover {
            transform: scale(1.1);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn-edit {
            background: var(--accent);
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            background: #f8f9fa;
            border-top: 1px solid var(--light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Image Modal */
        .image-modal-content {
            background: transparent;
            box-shadow: none;
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-modal-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .alert-icon {
            font-size: 18px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--light);
        }

        .toolbar button {
            padding: 10px 16px;
            font-size: 13px;
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                justify-content: center;
            }

            .status-bar {
                justify-content: center;
                width: 100%;
            }

            .content {
                padding: 20px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 10px;
                font-size: 12px;
            }

            .actions {
                flex-direction: column;
            }

            .btn-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .modal-content {
                max-width: 95vw;
            }

            .toolbar {
                flex-direction: column;
            }

            .toolbar button {
                width: 100%;
            }
        }

        /* Utility */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .text-center {
            text-align: center;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container">
        <div class="header">
            <h1>
                <span class="header-icon">üìã</span>
                Product Documentation & Image Register
            </h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Ready (Local Mode)</span>
                </div>
                <button class="btn-secondary" onclick="app.openSetupModal()" title="Configure Google Sheets">‚öôÔ∏è Setup</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn-success" onclick="app.exportToExcel()">
                üìä Export to Excel
            </button>
            <button class="btn-warning" onclick="app.syncToGoogleSheets()">
                ‚òÅÔ∏è Sync to Google Sheets
            </button>
            <button class="btn-secondary" onclick="app.clearAllData()" style="margin-left: auto;">
                üóëÔ∏è Clear All Data
            </button>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Form Section -->
            <div class="form-section">
                <h2>üìù New Product Record</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="date">Date <span class="required">*</span></label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label for="productName">Product Name <span class="required">*</span></label>
                        <input type="text" id="productName" placeholder="e.g., Orange Juice Premium" required>
                    </div>

                    <div class="form-group">
                        <label for="productFor">Product For <span class="required">*</span></label>
                        <textarea id="productFor" placeholder="e.g., Juice, Carbonated Drink, Basil Seed Drink, Confectionery" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="productDescription">Product Description <span class="required">*</span></label>
                        <textarea id="productDescription" placeholder="Detailed description of the product..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="productImage">Product Picture <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <label class="file-input-label" id="fileInputLabel" for="productImage" style="flex: 1; margin: 0;">
                                <span>üì∑ Upload</span>
                                <span style="font-size: 11px; color: var(--text-light);">Click or drag</span>
                            </label>
                            <button type="button" class="btn-primary" onclick="app.openCamera()" style="flex: 1; margin: 0;">
                                üì∏ Take Photo
                            </button>
                        </div>
                        <input type="file" id="productImage" accept=".jpg,.jpeg,.png" required>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                        <div class="image-preview-container" id="imagePreviewContainer">
                            <img id="imagePreview" class="image-preview" alt="Preview">
                            <div class="image-info" id="imageInfo"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="remarks">Remarks (Optional)</label>
                        <textarea id="remarks" placeholder="Additional notes..."></textarea>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn-primary" onclick="app.handleSubmit()">‚úÖ Submit Record</button>
                        <button type="reset" class="btn-secondary">üîÑ Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <h2 style="margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                    üìä Product Records
                </h2>
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="üîç Search by Product Name or Category...">
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <span style="display: flex; align-items: center; color: var(--text-light); font-size: 14px;">
                            Records: <strong id="recordCount" style="margin-left: 5px; color: var(--primary);">0</strong>
                        </span>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product Name</th>
                                <th>Product For</th>
                                <th>Description</th>
                                <th>Picture</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-state-icon">üì≠</div>
                                    <div>No records yet. Add your first product record above.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal" onclick="app.closeImageModal(event)">
        <div class="modal-content image-modal-content">
            <img id="modalImage" alt="Full view">
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Product Record</h2>
                <button class="modal-close" onclick="app.closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label for="editDate">Date</label>
                        <input type="date" id="editDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductName">Product Name</label>
                        <input type="text" id="editProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductFor">Product For</label>
                        <textarea id="editProductFor" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editProductDescription">Product Description</label>
                        <textarea id="editProductDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editProductImage">Product Picture (Optional - leave blank to keep current)</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <label class="file-input-label" id="editFileInputLabel" for="editProductImage" style="flex: 1; margin: 0;">
                                <span>üì∑ Upload</span>
                                <span style="font-size: 11px; color: var(--text-light);">Click or drag</span>
                            </label>
                            <button type="button" class="btn-primary" onclick="app.openEditCamera()" style="flex: 1; margin: 0;">
                                üì∏ Take Photo
                            </button>
                        </div>
                        <input type="file" id="editProductImage" accept=".jpg,.jpeg,.png">
                        <input type="file" id="editCameraInput" accept="image/*" capture="environment" style="display: none;">
                        <div class="image-preview-container" id="editImagePreviewContainer">
                            <img id="editImagePreview" class="image-preview" alt="Preview">
                            <div class="image-info" id="editImageInfo"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editRemarks">Remarks</label>
                        <textarea id="editRemarks"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="app.closeEditModal()">Cancel</button>
                <button class="btn-primary" onclick="app.saveEditRecord()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Google Sheets Setup</h2>
                <button class="modal-close" onclick="app.closeSetupModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <span class="alert-icon">‚ÑπÔ∏è</span>
                    <span>Paste your Google Apps Script Web App URL to enable automatic syncing.</span>
                </div>
                <div class="form-group">
                    <label for="gasUrl">Google Apps Script Web App URL</label>
                    <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/d/...">
                </div>
                <div class="form-group">
                    <label for="sheetName">Google Sheet Name (Optional)</label>
                    <input type="text" id="sheetName" placeholder="e.g., Product Records" value="Product Records">
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: var(--text-light);">
                    <strong>Setup Instructions:</strong>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Create a Google Sheet for your products</li>
                        <li>Create a Google Apps Script project linked to the sheet</li>
                        <li>Deploy as Web App (execute as you, accessible to anyone)</li>
                        <li>Copy the deployment URL and paste it above</li>
                        <li>Click "Save Configuration"</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="app.closeSetupModal()">Cancel</button>
                <button class="btn-success" onclick="app.saveSetupConfig()">üíæ Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirm Deletion</h2>
                <button class="modal-close" onclick="app.closeDeleteConfirm()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product record? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="app.closeDeleteConfirm()">Cancel</button>
                <button class="btn-danger" onclick="app.confirmDelete()">üóëÔ∏è Delete Record</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // PRODUCT REGISTER APP - Main Application Logic
        // ============================================================================

        const app = {
            // State Management
            state: {
                records: [],
                editingId: null,
                deleteId: null,
                gasUrl: localStorage.getItem('gasUrl') || '',
                sheetName: localStorage.getItem('sheetName') || 'Product Records',
                isConnected: false
            },

            // Format date as DD/MM/YYYY
            formatDateDDMMYYYY(dateString) {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            // Open camera for main form
            openCamera() {
                document.getElementById('cameraInput').click();
            },

            // Open camera for edit form
            openEditCamera() {
                document.getElementById('editCameraInput').click();
            },

                        // Initialize Application
            init() {
                this.loadRecords();
                this.setDefaultDate();
                this.setupEventListeners();
                this.updateConnectionStatus();
                this.renderTable();
            },

            // Set today's date as default
            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                document.getElementById('editDate').value = today;
            },

            // Setup Event Listeners
            setupEventListeners() {
                // Image upload with drag & drop
                this.setupImageUpload('productImage', 'fileInputLabel', 'imagePreview', 'imagePreviewContainer', 'imageInfo');
                this.setupImageUpload('editProductImage', 'editFileInputLabel', 'editImagePreview', 'editImagePreviewContainer', 'editImageInfo');

                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterTable(e.target.value);
                });

                // Modal close on background click
                document.getElementById('imageModal').addEventListener('click', (e) => {
                    if (e.target.id === 'imageModal') this.closeImageModal(e);
                });

                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') this.closeEditModal();
                });

                document.getElementById('setupModal').addEventListener('click', (e) => {
                    if (e.target.id === 'setupModal') this.closeSetupModal();
                });

                document.getElementById('deleteConfirmModal').addEventListener('click', (e) => {
                    if (e.target.id === 'deleteConfirmModal') this.closeDeleteConfirm();
                });

                // Camera input handlers
                document.getElementById('cameraInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleImageUpload(file, document.getElementById('productImage'), document.getElementById('fileInputLabel'), document.getElementById('imagePreview'), document.getElementById('imagePreviewContainer'), document.getElementById('imageInfo'));
                        e.target.value = '';
                    }
                });

                document.getElementById('editCameraInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleImageUpload(file, document.getElementById('editProductImage'), document.getElementById('editFileInputLabel'), document.getElementById('editImagePreview'), document.getElementById('editImagePreviewContainer'), document.getElementById('editImageInfo'));
                        e.target.value = '';
                    }
                });
            },

            // Setup Image Upload Handler
            setupImageUpload(inputId, labelId, previewId, containerClass, infoId) {
                const input = document.getElementById(inputId);
                const label = document.getElementById(labelId);
                const preview = document.getElementById(previewId);
                const container = document.getElementById(containerClass);
                const info = document.getElementById(infoId);

                // Click to upload
                label.addEventListener('click', () => input.click());

                // File selection
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleImageUpload(file, input, label, preview, container, info);
                        e.target.value = '';
                    }
                });

                // Drag & drop
                label.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'var(--accent)';
                    label.style.background = 'rgba(52, 152, 219, 0.1)';
                });

                label.addEventListener('dragleave', () => {
                    label.style.borderColor = 'var(--border)';
                    label.style.background = 'white';
                });

                label.addEventListener('drop', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'var(--border)';
                    label.style.background = 'white';
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        input.files = e.dataTransfer.files;
                        this.handleImageUpload(file, input, label, preview, container, info);
                    }
                });
            },

            // Handle Image Upload
            handleImageUpload(file, input, label, preview, container, info) {
                // Validate file type
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    alert('‚ùå Only JPG and PNG images are allowed.');
                    input.value = '';
                    return;
                }

                // Read and validate image
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const width = img.width;
                        const height = img.height;
                        const requiredWidth = 1280;
                        const requiredHeight = 1024;

                        // Resize and crop image to required dimensions
                        const resizedImage = this.resizeAndCropImage(img, requiredWidth, requiredHeight);
                        
                        // Display preview
                        preview.src = resizedImage;
                        container.classList.add('active');
                        info.textContent = `‚úì Resized to ${requiredWidth}√ó${requiredHeight}px | Original: ${width}√ó${height}px`;
                        label.classList.add('has-file');
                        
                        // Store the resized image back to the input for submission
                        this.storeResizedImage(input, resizedImage);
                    };
                    img.onerror = () => {
                        alert('‚ùå Failed to load image. Please try another file.');
                        input.value = '';
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    alert('‚ùå Failed to read file. Please try again.');
                    input.value = '';
                };
                reader.readAsDataURL(file);
            },

            // Resize and Crop Image to Exact Dimensions
            resizeAndCropImage(img, targetWidth, targetHeight) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                
                const imgWidth = img.width;
                const imgHeight = img.height;
                const imgRatio = imgWidth / imgHeight;
                const targetRatio = targetWidth / targetHeight;
                
                let sourceX = 0;
                let sourceY = 0;
                let sourceWidth = imgWidth;
                let sourceHeight = imgHeight;
                
                // Calculate crop dimensions to maintain aspect ratio
                if (imgRatio > targetRatio) {
                    // Image is wider, crop width
                    sourceWidth = imgHeight * targetRatio;
                    sourceX = (imgWidth - sourceWidth) / 2;
                } else {
                    // Image is taller, crop height
                    sourceHeight = imgWidth / targetRatio;
                    sourceY = (imgHeight - sourceHeight) / 2;
                }
                
                // Draw the cropped and resized image
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetWidth, targetHeight);
                
                // Return as Base64 data URL
                return canvas.toDataURL('image/jpeg', 0.95);
            },

            // Store Resized Image in Hidden Data Attribute
            storeResizedImage(input, resizedImageData) {
                // Store the resized image data in a data attribute
                input.dataset.resizedImage = resizedImageData;
            },

            // Handle Form Submit
            handleSubmit() {
                const date = document.getElementById('date').value;
                const productName = document.getElementById('productName').value;
                const productFor = document.getElementById('productFor').value;
                const productDescription = document.getElementById('productDescription').value;
                const remarks = document.getElementById('remarks').value;
                const imageInput = document.getElementById('productImage');

                // Validation
                if (!date || !productName || !productFor || !productDescription) {
                    alert('‚ùå Please fill in all required fields.');
                    return;
                }

                if (!imageInput.dataset.resizedImage) {
                    alert('‚ùå Please upload a product image.');
                    return;
                }

                // Use resized image
                const imageData = imageInput.dataset.resizedImage;
                
                const record = {
                    id: Date.now(),
                    date: date,
                    productName: productName,
                    productFor: productFor,
                    productDescription: productDescription,
                    image: imageData,
                    remarks: remarks
                };

                this.state.records.push(record);
                this.saveRecords();
                this.renderTable();
                this.showAlert('‚úÖ Product record saved successfully!', 'success');
                
                // Reset form
                document.getElementById('productForm').reset();
                this.setDefaultDate();
                document.getElementById('imagePreviewContainer').classList.remove('active');
                document.getElementById('fileInputLabel').classList.remove('has-file');
                imageInput.dataset.resizedImage = '';
                imageInput.value = '';
                document.getElementById('cameraInput').value = '';
            },

            // Open Edit Modal
            openEditModal(id) {
                const record = this.state.records.find(r => r.id === id);
                if (!record) return;

                this.state.editingId = id;
                document.getElementById('editDate').value = record.date;
                document.getElementById('editProductName').value = record.productName;
                document.getElementById('editProductFor').value = record.productFor;
                document.getElementById('editProductDescription').value = record.productDescription;
                document.getElementById('editRemarks').value = record.remarks || '';

                // Show current image
                const editImagePreview = document.getElementById('editImagePreview');
                const editImagePreviewContainer = document.getElementById('editImagePreviewContainer');
                editImagePreview.src = record.image;
                editImagePreviewContainer.classList.add('active');

                document.getElementById('editModal').classList.add('active');
            },

            // Close Edit Modal
            closeEditModal() {
                document.getElementById('editModal').classList.remove('active');
                document.getElementById('editProductImage').value = '';
                document.getElementById('editImagePreviewContainer').classList.remove('active');
                this.state.editingId = null;
            },

            // Save Edit Record
            saveEditRecord() {
                const record = this.state.records.find(r => r.id === this.state.editingId);
                if (!record) return;

                record.date = document.getElementById('editDate').value;
                record.productName = document.getElementById('editProductName').value;
                record.productFor = document.getElementById('editProductFor').value;
                record.productDescription = document.getElementById('editProductDescription').value;
                record.remarks = document.getElementById('editRemarks').value;

                // Handle new image if provided
                const imageFile = document.getElementById('editProductImage').files[0];
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        record.image = e.target.result;
                        this.saveRecords();
                        this.renderTable();
                        this.closeEditModal();
                        this.showAlert('‚úÖ Product record updated successfully!', 'success');
                    };
                    reader.onerror = () => {
                        alert('‚ùå Failed to read image file. Please try again.');
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    this.saveRecords();
                    this.renderTable();
                    this.closeEditModal();
                    this.showAlert('‚úÖ Product record updated successfully!', 'success');
                    document.getElementById('editProductImage').value = '';
                    document.getElementById('editCameraInput').value = '';
                }
            },

            // Open Delete Confirmation
            openDeleteConfirm(id) {
                this.state.deleteId = id;
                document.getElementById('deleteConfirmModal').classList.add('active');
            },

            // Close Delete Confirmation
            closeDeleteConfirm() {
                document.getElementById('deleteConfirmModal').classList.remove('active');
                this.state.deleteId = null;
            },

            // Confirm Delete
            confirmDelete() {
                this.state.records = this.state.records.filter(r => r.id !== this.state.deleteId);
                this.saveRecords();
                this.renderTable();
                this.closeDeleteConfirm();
                this.showAlert('‚úÖ Product record deleted successfully!', 'success');
            },

            // Open Image Modal
            openImageModal(imageData) {
                document.getElementById('modalImage').src = imageData;
                document.getElementById('imageModal').classList.add('active');
            },

            // Close Image Modal
            closeImageModal(event) {
                if (event.target.id === 'imageModal') {
                    document.getElementById('imageModal').classList.remove('active');
                }
            },

            // Filter Table by Search
            filterTable(searchTerm) {
                const term = searchTerm.toLowerCase();
                const rows = document.querySelectorAll('#tableBody tr');

                rows.forEach(row => {
                    if (row.textContent.toLowerCase().includes(term)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            },

            // Render Table
            renderTable() {
                const tbody = document.getElementById('tableBody');
                const recordCount = document.getElementById('recordCount');

                if (this.state.records.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <div>No records yet. Add your first product record above.</div>
                            </td>
                        </tr>
                    `;
                    recordCount.textContent = '0';
                    return;
                }

                tbody.innerHTML = this.state.records.map(record => `
                    <tr>
                        <td>${this.formatDateDDMMYYYY(record.date)}</td>
                        <td class="text-truncate">${this.escapeHtml(record.productName)}</td>
                        <td class="text-truncate">${this.escapeHtml(record.productFor)}</td>
                        <td class="text-truncate">${this.escapeHtml(record.productDescription.substring(0, 50))}...</td>
                        <td>
                            <img src="${record.image}" class="thumbnail" onclick="app.openImageModal('${record.image.replace(/'/g, "\\'")}')" alt="Product">
                        </td>
                        <td class="text-truncate">${this.escapeHtml(record.remarks || '-')}</td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon btn-edit" onclick="app.openEditModal(${record.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="app.openDeleteConfirm(${record.id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                recordCount.textContent = this.state.records.length;
            },

            // Save Records to localStorage
            saveRecords() {
                localStorage.setItem('productRecords', JSON.stringify(this.state.records));
            },

            // Load Records from localStorage
            loadRecords() {
                const saved = localStorage.getItem('productRecords');
                this.state.records = saved ? JSON.parse(saved) : [];
            },

            // Open Setup Modal
            openSetupModal() {
                document.getElementById('gasUrl').value = this.state.gasUrl;
                document.getElementById('sheetName').value = this.state.sheetName;
                document.getElementById('setupModal').classList.add('active');
            },

            // Close Setup Modal
            closeSetupModal() {
                document.getElementById('setupModal').classList.remove('active');
            },

            // Save Setup Configuration
            saveSetupConfig() {
                const gasUrl = document.getElementById('gasUrl').value.trim();
                const sheetName = document.getElementById('sheetName').value.trim();

                if (!gasUrl) {
                    alert('‚ùå Please enter a valid Google Apps Script URL.');
                    return;
                }

                this.state.gasUrl = gasUrl;
                this.state.sheetName = sheetName || 'Product Records';

                localStorage.setItem('gasUrl', gasUrl);
                localStorage.setItem('sheetName', sheetName);

                this.showAlert('‚úÖ Google Sheets configuration saved!', 'success');
                this.closeSetupModal();
                this.updateConnectionStatus();
            },

            // Update Connection Status
            updateConnectionStatus() {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                if (this.state.gasUrl) {
                    statusDot.classList.add('connected');
                    statusText.textContent = '‚úì Connected to Google Sheets';
                    this.state.isConnected = true;
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Ready (Local Mode)';
                    this.state.isConnected = false;
                }
            },

            // Sync to Google Sheets
            syncToGoogleSheets() {
                if (!this.state.gasUrl) {
                    alert('‚ùå Please configure Google Sheets first. Click "Setup" button.');
                    return;
                }

                if (this.state.records.length === 0) {
                    alert('‚ö†Ô∏è No records to sync.');
                    return;
                }

                const button = event.target;
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Syncing...';

                // Prepare data for Google Sheets
                const data = this.state.records.map(record => ({
                    date: record.date,
                    productName: record.productName,
                    productFor: record.productFor,
                    productDescription: record.productDescription,
                    remarks: record.remarks || '',
                    imageBase64: record.image
                }));

                // Send to Google Apps Script
                fetch(this.state.gasUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'syncRecords',
                        sheetName: this.state.sheetName,
                        records: data
                    })
                })
                .then(response => response.json())
                .then(result => {
                    button.disabled = false;
                    button.innerHTML = '‚òÅÔ∏è Sync to Google Sheets';
                    
                    if (result.success) {
                        this.showAlert(`‚úÖ Successfully synced ${result.recordsCount || this.state.records.length} records to Google Sheets!`, 'success');
                    } else {
                        this.showAlert(`‚ö†Ô∏è Sync completed with message: ${result.message || 'Check your Google Sheets'}`, 'info');
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    button.innerHTML = '‚òÅÔ∏è Sync to Google Sheets';
                    console.error('Sync error:', error);
                    this.showAlert(`‚ùå Sync failed: ${error.message}. Check console for details.`, 'error');
                });
            },

            // Export to Excel
            exportToExcel() {
                if (this.state.records.length === 0) {
                    alert('‚ö†Ô∏è No records to export.');
                    return;
                }

                const button = event.target;
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Exporting...';

                // Load ExcelJS library
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
                script.onload = () => {
                    this.createExcelFileWithImages();
                    button.disabled = false;
                    button.innerHTML = 'üìä Export to Excel';
                };
                script.onerror = () => {
                    button.disabled = false;
                    button.innerHTML = 'üìä Export to Excel';
                    this.showAlert('‚ùå Failed to load Excel library. Please try again.', 'error');
                };
                document.head.appendChild(script);
            },

                 // Create Excel File with Embedded Images using ExcelJS
            createExcelFileWithImages() {
                const ExcelJS = window.ExcelJS;
                if (!ExcelJS) {
                    this.showAlert('‚ùå Excel library not loaded.', 'error');
                    return;
                }

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Product Records');

                // Define columns
                worksheet.columns = [
                    { header: 'Date', key: 'date', width: 12 },
                    { header: 'Product Name', key: 'productName', width: 20 },
                    { header: 'Product For', key: 'productFor', width: 18 },
                    { header: 'Description', key: 'productDescription', width: 30 },
                    { header: 'Picture', key: 'picture', width: 52.65 },
                    { header: 'Remarks', key: 'remarks', width: 25 }
                ];

                // Style header row
                worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2c3e50' } };
                worksheet.getRow(1).alignment = { horizontal: 'center', vertical: 'center' };

                // Add data rows with images
                this.state.records.forEach((record, index) => {
                    const rowNum = index + 2;
                    const row = worksheet.addRow({
                        date: this.formatDateDDMMYYYY(record.date),
                        productName: record.productName,
                        productFor: record.productFor,
                        productDescription: record.productDescription,
                        remarks: record.remarks || ''
                    });

                    // Set row height to accommodate image (2.81 inches = 202.32 points)
                    row.height = 202.32;

                    // Add image to the Picture column (column E)
                    if (record.image) {
                        try {
                            // Convert base64 to blob
                            const base64Data = record.image.split(',')[1];
                            const binaryString = atob(base64Data);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            const blob = new Blob([bytes], { type: 'image/jpeg' });
                            
                            // Create image ID and add to workbook
                            const imageId = workbook.addImage({
                                buffer: blob,
                                extension: 'jpeg'
                            });

                            // Insert image in the cell with specific dimensions
                            // 3.51 inches width, 2.81 inches height
                            worksheet.addImage(imageId, {
                                tl: { col: 4, row: rowNum - 1 },
                                ext: { width: 337, height: 270 }
                            });
                        } catch (err) {
                            console.error('Error adding image:', err);
                        }
                    }

                    // Center align text cells
                    row.getCell('date').alignment = { horizontal: 'center', vertical: 'center' };
                    row.getCell('productName').alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                    row.getCell('productFor').alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                    row.getCell('productDescription').alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                    row.getCell('remarks').alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                });

                // Generate and download file
                const fileName = `Product_Records_${new Date().toISOString().split('T')[0]}.xlsx`;
                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    this.showAlert('‚úÖ Excel file with embedded images exported successfully!', 'success');
                }).catch(err => {
                    console.error('Error generating Excel file:', err);
                    this.showAlert('‚ùå Error generating Excel file. Please try again.', 'error');
                });
            },         // Clear All Data
            clearAllData() {
                if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL records? This cannot be undone.')) {
                    return;
                }

                this.state.records = [];
                this.saveRecords();
                this.renderTable();
                this.showAlert('‚úÖ All records cleared.', 'success');
            },

            // Show Alert
            showAlert(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `
                    <span class="alert-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
                    <span>${message}</span>
                `;

                const formSection = document.querySelector('.form-section');
                formSection.insertBefore(alertDiv, formSection.firstChild);

                setTimeout(() => alertDiv.remove(), 5000);
            },

            // Escape HTML to prevent XSS
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
        // Register Service Worker for offline support and caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                    })
                    .catch((error) => {
                        console.warn('Service Worker registration failed:', error);
                    });
            });

            // Listen for service worker updates
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Service Worker controller changed - app updated');
                // Optionally show a notification that the app has been updated
                if (window.app && window.app.showAlert) {
                    window.app.showAlert('‚úÖ App updated! Please refresh for the latest version.', 'success');
                }
            });
        }

        // Handle app installation prompts
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('Install prompt available');
            
            // You can show a custom install button here if desired
            // For now, the browser will show its own prompt
        });

        // Handle successful installation
        window.addEventListener('appinstalled', () => {
            console.log('App installed as PWA');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
