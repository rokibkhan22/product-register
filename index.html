<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Professional product documentation and image register for Quality/R&D teams">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Product Register">
    <link rel="apple-touch-icon" href="product-register.png">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="product-register.png">
    <title>Product Documentation & Image Register</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --text: #2c3e50;
            --text-light: #7f8c8d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .header-icon {
            font-size: 20px;
        }

        .status-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .content {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--light);
            background: white;
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            background: white;
            color: var(--text-light);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: #f8f9fa;
        }

        /* Form Section */
        .form-section {
            background: white;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .form-section.active {
            display: flex;
        }

        .form-section h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        button {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:active {
            background: #2980b9;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
        }

        .btn-secondary:active {
            background: #d5dbdb;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:active {
            background: #c0392b;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:active {
            background: #229954;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 6px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed var(--border);
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-input-label:active {
            background: #e8f4f8;
            border-color: var(--accent);
        }

        #fileInput, #cameraInput {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 8px;
        }

        .image-info {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Table Section */
        .table-section {
            background: white;
            padding: 0;
            display: none;
            flex-direction: column;
            gap: 0;
            flex: 1;
            overflow: hidden;
        }

        .table-section.active {
            display: flex;
        }

        .table-controls {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--light);
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 150px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
        }

        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overflow-x: auto;
        }

        /* Card Layout for Mobile */
        .records-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .record-card {
            background: white;
            border: 1px solid var(--light);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .record-card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
        }

        .record-card-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .record-card-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
            text-transform: uppercase;
        }

        .record-card-value {
            font-size: 12px;
            color: var(--text);
            word-break: break-word;
        }

        .record-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .record-card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 11px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--light);
            word-break: break-word;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .thumbnail {
            width: 50px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 4px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 8px;
            font-size: 11px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 12px;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px 12px 0 0;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--light);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .modal-footer button {
            flex: 1;
            padding: 10px;
        }

        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 12px;
            right: 12px;
            left: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert.success {
            background: var(--success);
            color: white;
        }

        .alert.error {
            background: var(--danger);
            color: white;
        }

        .alert.info {
            background: var(--accent);
            color: white;
        }

        /* Responsive Table - Show as cards on mobile */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
                width: 100%;
            }

            thead {
                display: none;
            }

            tr {
                margin-bottom: 12px;
                border: 1px solid var(--light);
                border-radius: 8px;
                overflow: hidden;
            }

            td {
                padding: 8px 12px;
                text-align: left;
                border-bottom: 1px solid var(--light);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            td:last-child {
                border-bottom: none;
            }

            td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-light);
                font-size: 11px;
                min-width: 100px;
            }

            .thumbnail {
                width: 60px;
                height: 48px;
            }
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><span class="header-icon">üìã</span> Product Register</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span id="statusText">Ready (Local)</span>
                </div>
                <button class="btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="app.openSetup()">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="app.switchTab('form')">‚ûï Add Record</button>
            <button class="tab-button" onclick="app.switchTab('table')">üìä View Records</button>
            <button class="tab-button" onclick="app.syncToGoogleSheets()">‚òÅÔ∏è Sync</button>
            <button class="tab-button" onclick="app.exportToExcel()">üì• Export</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Form Section -->
            <div class="form-section active" id="formSection">
                <h2>Product Information</h2>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="dateInput" required>
                </div>

                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="productNameInput" placeholder="e.g., Orange Juice" required>
                </div>

                <div class="form-group">
                    <label>Product For</label>
                    <textarea id="productForInput" placeholder="e.g., Juice, Carbonated Drink, etc." required></textarea>
                </div>

                <div class="form-group">
                    <label>Product Description</label>
                    <textarea id="descriptionInput" placeholder="Detailed description of the product" required></textarea>
                </div>

                <div class="form-group">
                    <label>Product Picture</label>
                    <div class="file-input-wrapper">
                        <label class="file-input-label" for="fileInput">üì∏ Upload Photo</label>
                        <input type="file" id="fileInput" accept="image/jpeg,image/png">
                    </div>
                    <div class="file-input-wrapper">
                        <label class="file-input-label" for="cameraInput">üì∑ Take Photo</label>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment">
                    </div>
                    <img id="imagePreview" class="image-preview" style="display: none;">
                    <div id="imageInfo" class="image-info"></div>
                </div>

                <div class="form-group">
                    <label>Remarks (Optional)</label>
                    <textarea id="remarksInput" placeholder="Additional notes"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="app.handleSubmit()">‚úì Submit</button>
                    <button class="btn-secondary" onclick="app.clearForm()">‚úï Clear</button>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section" id="tableSection">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="üîç Search..." onkeyup="app.filterTable()">
                    </div>
                </div>
                <div class="table-wrapper">
                    <div id="recordsContainer" class="records-cards"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Product Image</h2>
                <button class="modal-close" onclick="app.closeModal('imageModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" class="modal-image" alt="Product Image">
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Google Sheets Setup</h2>
                <button class="modal-close" onclick="app.closeModal('setupModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Google Apps Script Web App URL</label>
                    <textarea id="gasUrlInput" placeholder="Paste your Google Apps Script deployment URL here" style="min-height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Sheet Name (Optional)</label>
                    <input type="text" id="sheetNameInput" placeholder="Default: Product Records" value="Product Records">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="app.saveSetup()">üíæ Save</button>
                <button class="btn-secondary" onclick="app.closeModal('setupModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Record</h2>
                <button class="modal-close" onclick="app.closeModal('editModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="editDate">
                </div>
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="editProductName">
                </div>
                <div class="form-group">
                    <label>Product For</label>
                    <textarea id="editProductFor"></textarea>
                </div>
                <div class="form-group">
                    <label>Product Description</label>
                    <textarea id="editDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea id="editRemarks"></textarea>
                </div>
                <img id="editImagePreview" class="image-preview" style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="app.saveEdit()">‚úì Save</button>
                <button class="btn-danger" onclick="app.deleteRecord(app.editingIndex)">üóëÔ∏è Delete</button>
                <button class="btn-secondary" onclick="app.closeModal('editModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                records: [],
                gasUrl: '',
                sheetName: 'Product Records',
                currentTab: 'form'
            },
            editingIndex: null,

            init() {
                this.loadFromStorage();
                this.setDefaultDate();
                this.setupEventListeners();
                this.renderRecords();
                this.registerServiceWorker();
            },

            setupEventListeners() {
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleImageUpload(e));
                document.getElementById('cameraInput').addEventListener('change', (e) => this.handleImageUpload(e));
            },

            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dateInput').value = today;
            },

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 1280;
                        canvas.height = 1024;

                        const scale = Math.max(1280 / img.width, 1024 / img.height);
                        const x = (1280 - img.width * scale) / 2;
                        const y = (1024 - img.height * scale) / 2;

                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, 1280, 1024);
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        document.getElementById('imagePreview').src = resizedBase64;
                        document.getElementById('imagePreview').style.display = 'block';
                        document.getElementById('imageInfo').textContent = '‚úì Image resized to 1280√ó1024px';
                        this.currentImage = resizedBase64;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);

                event.target.value = '';
            },

            handleSubmit() {
                const date = document.getElementById('dateInput').value;
                const productName = document.getElementById('productNameInput').value.trim();
                const productFor = document.getElementById('productForInput').value.trim();
                const description = document.getElementById('descriptionInput').value.trim();
                const remarks = document.getElementById('remarksInput').value.trim();

                if (!date || !productName || !productFor || !description || !this.currentImage) {
                    this.showAlert('‚ùå Please fill all required fields and upload an image', 'error');
                    return;
                }

                const record = {
                    id: Date.now(),
                    date: this.formatDate(date),
                    productName,
                    productFor,
                    productDescription: description,
                    remarks,
                    image: this.currentImage
                };

                this.state.records.push(record);
                this.saveToStorage();
                this.renderRecords();
                this.clearForm();
                this.showAlert('‚úÖ Record added successfully!', 'success');
            },

            formatDate(dateStr) {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            },

            clearForm() {
                document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
                document.getElementById('productNameInput').value = '';
                document.getElementById('productForInput').value = '';
                document.getElementById('descriptionInput').value = '';
                document.getElementById('remarksInput').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imageInfo').textContent = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('cameraInput').value = '';
                this.currentImage = null;
            },

            renderRecords() {
                const container = document.getElementById('recordsContainer');
                if (this.state.records.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No records yet. Add one to get started!</p></div>';
                    return;
                }

                container.innerHTML = this.state.records.map((record, index) => `
                    <div class="record-card">
                        <img src="${record.image}" class="record-card-image" onclick="app.viewImage('${record.image}')">
                        <div class="record-card-field">
                            <div class="record-card-label">Date</div>
                            <div class="record-card-value">${record.date}</div>
                        </div>
                        <div class="record-card-field">
                            <div class="record-card-label">Product Name</div>
                            <div class="record-card-value">${record.productName}</div>
                        </div>
                        <div class="record-card-field">
                            <div class="record-card-label">Product For</div>
                            <div class="record-card-value">${record.productFor}</div>
                        </div>
                        <div class="record-card-field">
                            <div class="record-card-label">Description</div>
                            <div class="record-card-value">${record.productDescription}</div>
                        </div>
                        ${record.remarks ? `<div class="record-card-field">
                            <div class="record-card-label">Remarks</div>
                            <div class="record-card-value">${record.remarks}</div>
                        </div>` : ''}
                        <div class="record-card-actions">
                            <button class="btn-secondary" onclick="app.editRecord(${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" onclick="app.deleteRecord(${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            },

            filterTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filtered = this.state.records.filter(r => 
                    r.productName.toLowerCase().includes(searchTerm) || 
                    r.productFor.toLowerCase().includes(searchTerm)
                );
                this.renderFilteredRecords(filtered);
            },

            renderFilteredRecords(records) {
                const container = document.getElementById('recordsContainer');
                if (records.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No matching records found</p></div>';
                    return;
                }

                container.innerHTML = records.map((record, index) => {
                    const actualIndex = this.state.records.indexOf(record);
                    return `
                        <div class="record-card">
                            <img src="${record.image}" class="record-card-image" onclick="app.viewImage('${record.image}')">
                            <div class="record-card-field">
                                <div class="record-card-label">Date</div>
                                <div class="record-card-value">${record.date}</div>
                            </div>
                            <div class="record-card-field">
                                <div class="record-card-label">Product Name</div>
                                <div class="record-card-value">${record.productName}</div>
                            </div>
                            <div class="record-card-field">
                                <div class="record-card-label">Product For</div>
                                <div class="record-card-value">${record.productFor}</div>
                            </div>
                            <div class="record-card-field">
                                <div class="record-card-label">Description</div>
                                <div class="record-card-value">${record.productDescription}</div>
                            </div>
                            ${record.remarks ? `<div class="record-card-field">
                                <div class="record-card-label">Remarks</div>
                                <div class="record-card-value">${record.remarks}</div>
                            </div>` : ''}
                            <div class="record-card-actions">
                                <button class="btn-secondary" onclick="app.editRecord(${actualIndex})">‚úèÔ∏è Edit</button>
                                <button class="btn-danger" onclick="app.deleteRecord(${actualIndex})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            editRecord(index) {
                this.editingIndex = index;
                const record = this.state.records[index];
                document.getElementById('editDate').value = record.date.split('/').reverse().join('-');
                document.getElementById('editProductName').value = record.productName;
                document.getElementById('editProductFor').value = record.productFor;
                document.getElementById('editDescription').value = record.productDescription;
                document.getElementById('editRemarks').value = record.remarks || '';
                document.getElementById('editImagePreview').src = record.image;
                document.getElementById('editImagePreview').style.display = 'block';
                this.openModal('editModal');
            },

            saveEdit() {
                const record = this.state.records[this.editingIndex];
                record.date = this.formatDate(document.getElementById('editDate').value);
                record.productName = document.getElementById('editProductName').value.trim();
                record.productFor = document.getElementById('editProductFor').value.trim();
                record.productDescription = document.getElementById('editDescription').value.trim();
                record.remarks = document.getElementById('editRemarks').value.trim();

                this.saveToStorage();
                this.renderRecords();
                this.closeModal('editModal');
                this.showAlert('‚úÖ Record updated successfully!', 'success');
            },

            deleteRecord(index) {
                if (confirm('Are you sure you want to delete this record?')) {
                    this.state.records.splice(index, 1);
                    this.saveToStorage();
                    this.renderRecords();
                    this.closeModal('editModal');
                    this.showAlert('‚úÖ Record deleted successfully!', 'success');
                }
            },

            viewImage(imageSrc) {
                document.getElementById('modalImage').src = imageSrc;
                this.openModal('imageModal');
            },

            switchTab(tab) {
                this.state.currentTab = tab;
                document.querySelectorAll('.tab-button').forEach((btn, idx) => {
                    btn.classList.toggle('active', (idx === 0 && tab === 'form') || (idx === 1 && tab === 'table'));
                });
                document.getElementById('formSection').classList.toggle('active', tab === 'form');
                document.getElementById('tableSection').classList.toggle('active', tab === 'table');
            },

            filterTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filtered = this.state.records.filter(r => 
                    r.productName.toLowerCase().includes(searchTerm) || 
                    r.productFor.toLowerCase().includes(searchTerm)
                );
                this.renderFilteredRecords(filtered);
            },

            syncToGoogleSheets() {
                if (!this.state.gasUrl) {
                    this.showAlert('‚ùå Please configure Google Sheets first', 'error');
                    this.openModal('setupModal');
                    return;
                }

                if (this.state.records.length === 0) {
                    this.showAlert('‚ö†Ô∏è No records to sync', 'info');
                    return;
                }

                const data = this.state.records.map(record => ({
                    date: record.date,
                    productName: record.productName,
                    productFor: record.productFor,
                    productDescription: record.productDescription,
                    remarks: record.remarks || '',
                    imageBase64: record.image
                }));

                fetch(this.state.gasUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'syncRecords',
                        sheetName: this.state.sheetName,
                        records: data
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        this.showAlert(`‚úÖ Synced! New: ${result.newRecords || 0}, Updated: ${result.updatedRecords || 0}, Deleted: ${result.deletedRecords || 0}`, 'success');
                        document.getElementById('statusText').textContent = 'Connected to Google Sheets';
                    } else {
                        this.showAlert(`‚ö†Ô∏è ${result.message}`, 'info');
                    }
                })
                .catch(error => {
                    this.showAlert(`‚ùå Sync failed: ${error.message}`, 'error');
                });
            },

            exportToExcel() {
                if (this.state.records.length === 0) {
                    this.showAlert('‚ö†Ô∏è No records to export', 'info');
                    return;
                }

                this.showAlert('üì• Exporting to Excel...', 'info');
                this.createExcelFile();
            },

            createExcelFile() {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
                script.onload = () => {
                    const ExcelJS = window.ExcelJS;
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('Product Records');

                    worksheet.columns = [
                        { header: 'Date', key: 'date', width: 12 },
                        { header: 'Product Name', key: 'productName', width: 20 },
                        { header: 'Product For', key: 'productFor', width: 20 },
                        { header: 'Description', key: 'productDescription', width: 25 },
                        { header: 'Remarks', key: 'remarks', width: 20 },
                        { header: 'Picture', key: 'picture', width: 52.65 }
                    ];

                    worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2c3e50' } };

                    this.state.records.forEach(record => {
                        const row = worksheet.addRow({
                            date: record.date,
                            productName: record.productName,
                            productFor: record.productFor,
                            productDescription: record.productDescription,
                            remarks: record.remarks || ''
                        });

                        row.height = 202.32;

                        if (record.image) {
                            const imageId = workbook.addImage({
                                base64: record.image,
                                extension: 'jpeg'
                            });
                            worksheet.addImage(imageId, `F${row.number}:F${row.number}`);
                            worksheet.getColumn('F').width = 52.65;
                        }
                    });

                    workbook.xlsx.writeBuffer().then(buffer => {
                        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `Product_Register_${new Date().toISOString().split('T')[0]}.xlsx`;
                        link.click();
                        this.showAlert('‚úÖ Excel file downloaded!', 'success');
                    });
                };
                document.head.appendChild(script);
            },

            openSetup() {
                document.getElementById('gasUrlInput').value = this.state.gasUrl;
                document.getElementById('sheetNameInput').value = this.state.sheetName;
                this.openModal('setupModal');
            },

            saveSetup() {
                this.state.gasUrl = document.getElementById('gasUrlInput').value.trim();
                this.state.sheetName = document.getElementById('sheetNameInput').value.trim() || 'Product Records';
                this.saveToStorage();
                this.closeModal('setupModal');
                this.showAlert('‚úÖ Setup saved!', 'success');
                if (this.state.gasUrl) {
                    document.getElementById('statusText').textContent = 'Connected to Google Sheets';
                }
            },

            openModal(id) {
                document.getElementById(id).classList.add('active');
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            },

            showAlert(message, type = 'info') {
                const alert = document.createElement('div');
                alert.className = `alert ${type}`;
                alert.textContent = message;
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 3000);
            },

            saveToStorage() {
                localStorage.setItem('productRegisterData', JSON.stringify(this.state));
            },

            loadFromStorage() {
                const data = localStorage.getItem('productRegisterData');
                if (data) {
                    this.state = JSON.parse(data);
                }
            },

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
                }
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
